<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Betty Bot ‚Äî Integration</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  {# ====== CONFIG (from app.py) ====== #}
  {% set primary    = (cfg.color_hex if (cfg and cfg.color_hex) else '#4F46E5') %}
  {% set shape      = (cfg.shape if (cfg and cfg.shape) else 'rounded') %}
  {% set bot_name   = (cfg.name if (cfg and cfg.name) else 'My Betty Bot') %}
  {% set pack_slug  = (cfg.slug if (cfg and cfg.slug) else 'agent_immobilier') %}
  {% set persona    = (cfg.persona if (cfg and cfg.persona) else 'neutre') %}
  {% set bot_id     = (bot.get('id') if bot else None) %}

  {% set show_brand      = True %}
  {% set brand_text      = (cfg.brand_text if cfg and cfg.brand_text else 'Betty Bot ‚Äî powered by Spectra Media') %}
  {% set brand_link      = (cfg.brand_link if cfg and cfg.brand_link else 'https://spectramedia.ai') %}

  {% set pack_labels = {
    'agent_immobilier':'Real estate agent',
    'avocat':'Lawyer',
    'medecin':'Doctor'
  } %}
  {% set pack_label = pack_labels.get(pack_slug, pack_slug) %}
  {% set avatar_url = (cfg.avatar_url if (cfg and cfg.avatar_url) else '/avatar/agent_immo') %}

  <style>
    :root{
      --bg:#0b0b0c;
      --card:#111214;
      --line:#23262d;
      --text:#e7e9ee;
      --muted:#a7adbb;
      --primary:{{ primary }};
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif
    }

    /* Branding bar */
    .bb-brand{
      position:sticky;top:0;left:0;right:0;height:34px;z-index:999;
      background:#0b0b0f;color:#cbd5e1;border-bottom:1px solid rgba(255,255,255,.06);
      font:500 12px/34px Inter,system-ui,sans-serif;text-align:center;letter-spacing:.2px
    }
    .bb-brand a{color:#a5b4fc;text-decoration:none}

    .wrap{max-width:860px;margin:22px auto;padding:0 18px}
    .row{display:flex;align-items:center;gap:14px;margin:6px 0 18px}
    .avatar{
      width:64px;height:64px;border:1px solid var(--line);overflow:hidden;background:#0f1012;
      border-radius:{% if shape=='circle' %}50%{% elif shape=='rounded' %}12px{% else %}8px{% endif %};
      flex:0 0 64px
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .chat{display:flex;flex-direction:column;height:62vh;min-height:420px}
    .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
    .bubble{
      max-width:80%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.35;
      border:1px solid var(--line);
      white-space:pre-wrap
    }
    .me{align-self:flex-end;background:#1a1d24}
    .bot{align-self:flex-start;background:#101216}
    .bubble.warn{color:#ffdb6e;border-color:#3b2f0b;background:#1c1606}

    .input{display:flex;gap:8px;margin-top:10px}
    .input input{
      flex:1;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:#0f1012;color:var(--text)
    }
    .input button{
      padding:12px 14px;border-radius:12px;border:0;background:var(--primary);color:#fff;font-weight:600;cursor:pointer
    }
    .input button[disabled]{opacity:.6;cursor:not-allowed}
    .small{color:var(--muted);font-size:12px;margin-top:6px}
    .kbd{display:inline-block;background:#0f1012;border:1px solid var(--line);padding:0 6px;border-radius:6px}
  </style>
</head>

<body>
  <div class="bb-brand">
    <a href="{{ brand_link }}" target="_blank" rel="noopener">{{ brand_text }}</a>
  </div>

  <div class="wrap">
    <div class="row">
      <div class="avatar"><img src="{{ avatar_url }}" alt="avatar"></div>
      <div>
        <h1>{{ bot_name }}</h1>
        <div class="sub">Pack: {{ pack_label }}</div>
      </div>
    </div>

    <div class="card">
      <div class="chat">
        <div id="messages" class="messages"></div>
        <div class="input">
          <input id="msg" placeholder="Type your message‚Ä¶" autocomplete="off">
          <button id="send">Send</button>
        </div>
        <div class="small">
          Tip: press <span class="kbd">Enter</span> to send. For example: ‚ÄúI‚Äôd like an appointment tomorrow‚Äù.
        </div>
      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- ========== SCRIPT ========= -->
  <!-- =========================== -->
  <script>
    // -------- Context sent by the server --------
    const BOT_ID   = {{ bot_id|tojson }};
    const PACK     = {{ pack_slug|tojson }};
    const PRIMARY  = {{ primary|tojson }};
    let   persona  = {{ persona|tojson }};

    // Public contact details (if set in the dashboard)
    const PRO_PHONE         = {{ (cfg.pro_phone or '')|tojson }};
    const PRO_ADDRESS_LABEL = {{ (cfg.pro_address_label or '')|tojson }};
    const PRO_ADDRESS_URL   = {{ (cfg.pro_address_url or '')|tojson }};
    const MAP_URL = (PRO_ADDRESS_URL && PRO_ADDRESS_URL.trim())
      ? PRO_ADDRESS_URL
      : (PRO_ADDRESS_LABEL ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(PRO_ADDRESS_LABEL)}` : null);

    // -------- Pack-specific lead prompts --------
    const LEAD_PROMPTS = {
      agent_immobilier: "Are you looking to buy, sell or rent? In which area?",
      avocat:           "What type of case is it (family, work, criminal...) and how urgent is it?",
      medecin:          "What is the reason for your visit and what are your availabilities?"
    };
    const START_GREETING = {{ (cfg.welcome_text or 'Hello üëã')|tojson }};

    // -------- UI --------
    const messagesEl = document.getElementById('messages');
    const msgInput   = document.getElementById('msg');
    const sendBtn    = document.getElementById('send');

    // Text bubble
    function addBubble(text, who='bot', cls=null){
      const b = document.createElement('div');
      b.className = 'bubble ' + (who === 'me' ? 'me' : 'bot') + (cls ? (' ' + cls) : '');
      b.textContent = String(text || '');
      messagesEl.appendChild(b);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // HTML bubble (for clickable contact info)
    function addHtmlBubble(html){
      const b = document.createElement('div');
      b.className = 'bubble bot';
      b.innerHTML = html;
      messagesEl.appendChild(b);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Minimal history (user messages only)
    function userHistory(){
      return Array.from(messagesEl.querySelectorAll('.bubble.me')).map(el => el.textContent);
    }

    // -------- Universal lead collection --------
    const lead = { nom:"", prenom:"", telephone:"", email:"" };
    let leadStep = 0; // 0:last name,1:first name,2:phone,3:email,4:done
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;

    // Regex to detect and strip the lead JSON metadata from the model's reply.
    const LEAD_RE = /<LEAD_JSON>(\{[\s\S]*?\})(?:<\/LEAD_JSON>)?/;
    function stripLead(s){
      if (!s) return '';
      return s.replace(LEAD_RE, '').trim();
    }

    function isLeadComplete(l){ return l.nom && l.prenom && l.telephone && l.email; }

    function nextLeadQuestion(){
      if (leadStep === 0) return addBubble("What is your LAST NAME?");
      if (leadStep === 1) return addBubble("And your FIRST NAME?");
      if (leadStep === 2) return addBubble("Your PHONE NUMBER (mobile preferred)?");
      if (leadStep === 3) return addBubble("Finally, your EMAIL address?");
    }

    function acceptLeadAnswer(text){
      const t = (text || "").trim();
      if (!t) return false;
      if (leadStep === 0) { lead.nom = t.toUpperCase(); leadStep = 1; return true; }
      if (leadStep === 1) { lead.prenom = t.charAt(0).toUpperCase() + t.slice(1); leadStep = 2; return true; }
      if (leadStep === 2) {
        const digits = t.replace(/[^\d+]/g,"");
        if (digits.length < 8) { addBubble("That phone number seems too short. Could you check it?", "bot", "warn"); return true; }
        lead.telephone = digits; leadStep = 3; return true;
      }
      if (leadStep === 3) {
        if (!emailRe.test(t)) { addBubble("That email doesn‚Äôt look valid. Could you type it again?", "bot", "warn"); return true; }
        lead.email = t; leadStep = 4; return true;
      }
      return false;
    }

    async function submitLeadIfComplete(){
      if (!isLeadComplete(lead)) return;
      addBubble(
        `Thank you ${lead.prenom} ${lead.nom}. I‚Äôve saved:\n- Phone: ${lead.telephone}\n- Email: ${lead.email}\nSomeone will get back to you shortly.`,
        "bot", null
      );
      const payload = {
        name: `${lead.prenom} ${lead.nom}`,
        email: lead.email,
        message: `Lead ${PACK}\nNom: ${lead.nom}\nPr√©nom: ${lead.prenom}\nT√©l√©phone: ${lead.telephone}\nEmail: ${lead.email}`,
        extra: { metier: PACK }
      };
      try{
        await fetch('/api/lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
      } catch {/* silent in embed */}
    }

    // -------- Business info reply (phone / address) --------
    function userAsksForBusinessInfo(text){
      const t = (text || '').toLowerCase();
      const askPhone = /(t(√©|e)l(√©|e)phone|num(√©|e)ro|joindre|appeler|appel|phone|call|number)/i.test(t) && !!PRO_PHONE;
      const askAddr  = /(adresse|address|where\s+are\s+you|location|venir|o(√π|u)\s+(vous\s+)?(situez|trouvez)|map|google\s+maps)/i.test(t)
                        && (!!PRO_ADDRESS_LABEL || !!MAP_URL);
      return { askPhone, askAddr };
    }

    function answerBusinessInfoIfAsked(text){
      const { askPhone, askAddr } = userAsksForBusinessInfo(text);
      if (!askPhone && !askAddr) return false;
      const parts = [];
      if (askPhone && PRO_PHONE) { parts.push(`üìû Phone: <b>${PRO_PHONE}</b>`); }
      if (askAddr && (PRO_ADDRESS_LABEL || MAP_URL)) {
        const link = MAP_URL ? `<a href="${MAP_URL}" target="_blank" rel="noopener">open in Google Maps</a>` : '';
        const label = PRO_ADDRESS_LABEL ? `<b>${PRO_ADDRESS_LABEL}</b>` : '';
        parts.push(`üìç Address: ${label}${label && link ? " ‚Äî " : ""}${link}`);
      }
      if (parts.length) addHtmlBubble(parts.join("<br>"));
      return true;
    }

    // -------- API call to the m√©tier backend --------
    async function callChatAPI(text){
      const payload = {
        message: text,
        history: userHistory(),
        pack: PACK,
        persona,
        color: PRIMARY,
        bot_id: BOT_ID,
        lead,
        business: { phone: PRO_PHONE, address_label: PRO_ADDRESS_LABEL, address_url: MAP_URL }
      };
      try{
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        const ctype = (res.headers.get('content-type')||'').toLowerCase();
        if (!ctype.includes('application/json')) return { ok:false };
        const data = await res.json().catch(()=>null);
        return { ok: res.ok && !!data, data };
      } catch { return { ok:false }; }
    }

    // -------- Sending --------
    let sending = false;
    async function send(text){
      const t = (text || '').trim();
      if (!t || sending) return;
      sending = true; sendBtn.disabled = true;
      addBubble(t, 'me'); msgInput.value = '';
      answerBusinessInfoIfAsked(t);
      const progressed = acceptLeadAnswer(t);
      if (progressed) {
        if (leadStep < 4) { nextLeadQuestion(); sending = false; sendBtn.disabled = false; msgInput.focus(); return; }
        await submitLeadIfComplete();  // silent send
      }
      const { ok, data } = await callChatAPI(t);
      if (!ok || !data || typeof data.reply !== 'string') {
        addBubble('I didn‚Äôt quite get that, could you clarify?', 'bot', 'warn');
      } else {
        // Strict filtering: never ask a question from another pack
        const safePrompts = {
          agent_immobilier: /(acheter|vendre|louer|buy|sell|rent|budget|zone|quartier|area|neighborhood|surface|square\s*meters?|rooms?)/i,
          avocat: /(dossier|p[√©e]nal|travail|famille|prud.hom|urgence|tribunal|case|lawsuit|court|legal)/i,
          medecin: /(consultation|douleur|sympt[o√¥]me|disponibilit[e√©]s|rdv|rendez|appointment|symptoms?|doctor)/i
        };
        const rawReply = (data.reply || '').trim();
        // Strip lead JSON metadata from the reply before filtering
        const reply = stripLead(rawReply);
        const okPack = safePrompts[PACK] ? safePrompts[PACK].test(reply) || /^bonjour|^hello/i.test(reply) : true;
        addBubble(okPack ? reply : (LEAD_PROMPTS[PACK] || "Could you tell me a bit more about your request?"), 'bot');
      }
      sending = false; sendBtn.disabled = false; msgInput.focus();
    }

    // UI events
    sendBtn.addEventListener('click', ()=> send(msgInput.value));
    msgInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); send(msgInput.value); } });

    // -------- Initial messages (auto-focus + pack prompt) --------
    (()=>{
      addBubble(START_GREETING, 'bot');
      const hint = LEAD_PROMPTS[PACK] || "Could you tell me a bit more about your request?";
      addBubble(hint, 'bot');
      nextLeadQuestion(); // ask LAST NAME first
      msgInput.focus();
    })();
  </script>
</body>
</html>
