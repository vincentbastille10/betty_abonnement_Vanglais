{% extends "base.html" %}
{% block content %}

<style>
  .metier-drawer {
    margin-top: 1rem;
  }
  .drawer-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    border: 1px solid #4F46E5;
    background: #0f172a;
    color: #e5e7eb;
    font-size: 0.9rem;
    cursor: pointer;
  }
  .drawer-toggle.open {
    background: #4F46E5;
    color: #ffffff;
  }
  .selected-metier-label {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #e5e7eb;
  }
  .selected-metier-label strong {
    color: #ffffff;
  }

  /* Selected avatar block + caption */
  .selected-metier-avatar {
    margin-top: 0.4rem;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.85rem;
    color: #e5e7eb;
  }
  .selected-metier-avatar img.avatar-preview-img {
    width: 52px;
    height: 52px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid #4F46E5;
    background: #020617;
  }
  .selected-metier-avatar-text {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }
  .selected-metier-avatar-text span {
    font-weight: 500;
    color: #e5e7eb;
  }
  .selected-metier-avatar-text small {
    font-size: 0.75rem;
    color: #9ca3af;
  }

  .drawer-panel {
    margin-top: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.75rem;
    background: #020617;
    border: 1px solid #1f2937;
  }
  .drawer-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .drawer-chip {
    border-radius: 999px;
    padding: 0.4rem 0.9rem;
    border: 1px solid #4b5563;
    background: #0b1120;
    color: #e5e7eb;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
  }
  .drawer-chip:hover {
    border-color: #4F46E5;
    transform: translateY(-1px);
  }
  .drawer-chip.active {
    border-color: #4F46E5;
    background: #4F46E5;
    color: #ffffff;
  }
</style>

<h1>Configure your chatbot</h1>
<p class="intro">Choose a profession, a color, adjust the personality, and customize the welcome message.</p>

<form method="POST" action="{{ url_for('config_page') }}" id="cfg-form" class="cfg-grid">

  <!-- Profession / Avatar -->
  <section class="card">
    <h2>Profession</h2>
    <p class="hint">Select a main avatar or open the drawer to access all available Betty professions.</p>

    <div class="avatar-grid">

      <!-- Lawyer -->
      <label class="avatar-card selected">
        <input type="radio" name="pack" value="avocat" data-avatar="avocat.jpg" checked>
        <img src="{{ url_for('static', filename='avocat.jpg') }}" alt="Lawyer">
        <div class="a-label">Lawyer</div>
      </label>

      <!-- Doctor -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="medecin" data-avatar="medecin.jpg">
        <img src="{{ url_for('static', filename='medecin.jpg') }}" alt="Doctor">
        <div class="a-label">Doctor</div>
      </label>

      <!-- Real estate -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="immo" data-avatar="immo.jpg">
        <img src="{{ url_for('static', filename='immo.jpg') }}" alt="Real estate">
        <div class="a-label">Real estate</div>
      </label>

    </div>
    <small class="hint">Click to select. Display size: 4 cm Ã— 4 cm.</small>

    <!-- ðŸ”’ Only ONE avatar is sent to the backend -->
    <input type="hidden" name="avatar" id="avatar-hidden" value="avocat.jpg">

    <!-- ===== PROFESSION DRAWER ===== -->
    <div class="metier-drawer">
      <button type="button" class="drawer-toggle" id="drawer-toggle">
        More professions: open the full list
      </button>

      <p id="metier-selected-label" class="selected-metier-label">
        Selected profession: <strong>Lawyer</strong>. You can continue configuring your bot.
      </p>

      <!-- Avatar preview + legend -->
      <div class="selected-metier-avatar">
        <img id="avatar-preview"
             src="{{ url_for('static', filename='avocat.jpg') }}"
             alt="Selected avatar"
             class="avatar-preview-img">
        <div class="selected-metier-avatar-text">
          <span>Selected avatar</span>
          <small>This is the picture used in your intelligent Betty chatbot.</small>
        </div>
      </div>

      <div class="drawer-panel" id="drawer-panel" hidden>
        <p class="hint">Click on your profession to load the corresponding avatar and configuration pack.</p>

        <!-- Hidden radio that will carry the pack chosen in the drawer -->
        <input type="radio" name="pack" id="drawer-pack-radio" value="" data-avatar="" style="display:none">

        <div class="drawer-grid">
          <!-- Alphabetical order based on human label -->
          <button type="button" class="drawer-chip"
                  data-pack="betty_aide_a_domicile"
                  data-avatar="Betty_aide_a_domicile.png"
                  data-label="Home care">
            Home care
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_aide_a_dom"
                  data-avatar="Betty_aide_a_dom.png"
                  data-label="Home care (quick)">
            Home care (quick)
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_architecte"
                  data-avatar="Betty_architecte.png"
                  data-label="Architect">
            Architect
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_artisan"
                  data-avatar="Betty_artisan.png"
                  data-label="Craftsman / Artisan">
            Craftsman / Artisan
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_assistance_scolaire"
                  data-avatar="Betty_assistance_scolaire.png"
                  data-label="School assistance">
            School assistance
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_assurance"
                  data-avatar="Betty_assurance.png"
                  data-label="Insurance">
            Insurance
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_coach"
                  data-avatar="Betty_coach.png"
                  data-label="Coach">
            Coach
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_coiffeur"
                  data-avatar="Betty_coiffeur.png"
                  data-label="Hairdresser">
            Hairdresser
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_dentiste"
                  data-avatar="Betty_dentiste.png"
                  data-label="Dentist">
            Dentist
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_dj"
                  data-avatar="Betty_DJ.png"
                  data-label="DJ">
            DJ
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_estheticienne"
                  data-avatar="Betty_estheticienne.png"
                  data-label="Beautician">
            Beautician
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_garde_denfant"
                  data-avatar="Betty_garde_denfant.png"
                  data-label="Childcare">
            Childcare
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_graphiste"
                  data-avatar="Betty_graphiste.png"
                  data-label="Graphic designer">
            Graphic designer
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_infirmiere"
                  data-avatar="Betty_infirmiere.png"
                  data-label="Nurse">
            Nurse
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_kine"
                  data-avatar="Betty_kine.png"
                  data-label="Physiotherapist">
            Physiotherapist
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_marketing"
                  data-avatar="Betty_marketing.png"
                  data-label="Marketing">
            Marketing
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_mecano"
                  data-avatar="Betty_mecano.png"
                  data-label="Mechanic">
            Mechanic
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_menage"
                  data-avatar="Betty_menage.png"
                  data-label="Cleaning services">
            Cleaning services
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_nutritioniste"
                  data-avatar="Betty_nutritioniste.png"
                  data-label="Nutritionist">
            Nutritionist
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_osteopate"
                  data-avatar="Betty_osteopate.png"
                  data-label="Osteopath">
            Osteopath
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_paysagiste"
                  data-avatar="Betty_paysagiste.png"
                  data-label="Landscaper">
            Landscaper
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_photographe"
                  data-avatar="Betty_photographe.png"
                  data-label="Photographer">
            Photographer
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_plombier"
                  data-avatar="Betty_plombier.png"
                  data-label="Plumber">
            Plumber
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_serrurier"
                  data-avatar="Betty_serrurier.png"
                  data-label="Locksmith">
            Locksmith
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_sophrologue"
                  data-avatar="Betty_sophrologue.png"
                  data-label="Sophrologist / stress coach">
            Sophrologist / stress coach
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_soutien_scolaire"
                  data-avatar="Betty_soutien_scolaire.png"
                  data-label="Tutoring / homework help">
            Tutoring / homework help
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_trader"
                  data-avatar="Betty_trader.png"
                  data-label="Trader">
            Trader
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_traiteur"
                  data-avatar="Betty_traiteur.png"
                  data-label="Caterer">
            Caterer
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_verrier"
                  data-avatar="Betty_verrier.png"
                  data-label="Glassmaker">
            Glassmaker
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_yoga"
                  data-avatar="Betty_yoga.png"
                  data-label="Yoga teacher">
            Yoga teacher
          </button>
        </div>
      </div>
    </div>
    <!-- ===== /PROFESSION DRAWER ===== -->

  </section>

  <!-- Colors -->
  <section class="card">
    <h2>Color</h2>
    <div class="color-grid">
      <label class="color-swatch" style="--c:#4F46E5">
        <input type="radio" name="color" value="#4F46E5" checked>
      </label>
      <label class="color-swatch" style="--c:#16A34A">
        <input type="radio" name="color" value="#16A34A">
      </label>
      <label class="color-swatch" style="--c:#0284C7">
        <input type="radio" name="color" value="#0284C7">
      </label>
      <label class="color-swatch" style="--c:#DB2777">
        <input type="radio" name="color" value="#DB2777">
      </label>
      <label class="color-swatch" style="--c:#F59E0B">
        <input type="radio" name="color" value="#F59E0B">
      </label>
      <label class="color-swatch" style="--c:#10B981">
        <input type="radio" name="color" value="#10B981">
      </label>
    </div>
  </section>

  <!-- Personality (2D slider) -->
  <section class="card">
    <h2>Personality</h2>
    <div class="axes-wrap">
      <div class="axis-label top">Warm</div>
      <div class="axis-label left">Empathetic</div>
      <div class="joystick" id="joy">
        <div class="thumb" id="thumb"></div>
      </div>
      <div class="axis-label right">Efficient</div>
      <div class="axis-label bottom">Precise</div>
    </div>
    <input type="hidden" name="persona_x" id="persona_x" value="0">
    <input type="hidden" name="persona_y" id="persona_y" value="0">
    <small class="hint">Move the cursor: left = more empathetic, right = more efficient, up = warmer, down = more precise.</small>
  </section>

  <!-- Business information -->
  <section class="card">
    <h2>Business information</h2>
    <label class="field">
      <span>Name / Company</span>
      <input type="text" name="info_name" placeholder="e.g. Dupont Law Firm">
    </label>

    <label class="field">
      <span>Phone</span>
      <input type="text" name="info_phone" placeholder="e.g. +33 2 43 XX XX XX">
    </label>

    <label class="field">
      <span>Contact email</span>
      <input type="email" name="info_email" placeholder="e.g. contact@dupont-law.com">
    </label>

    <label class="field">
      <span>Address</span>
      <textarea name="info_address" rows="3"
        placeholder="e.g. 12 Rue de la RÃ©publique, 72000 Le Mans, France"></textarea>
    </label>

  </section>

  <!-- CTA -->
  <div class="cta">
    <button type="submit" class="btn primary big">Save and subscribe</button>
  </div>
</form>

<script>
  // ====== Pack <-> Avatar: 100% reliable sync ======
  const AVATAR_BASE = "{{ url_for('static', filename='') }}";

  const packRadios   = document.querySelectorAll('input[type="radio"][name="pack"]');
  const avatarHidden = document.getElementById('avatar-hidden');
  const cards        = document.querySelectorAll('.avatar-card');
  const metierLabel  = document.getElementById('metier-selected-label');

  function updateMetierLabelFromRadio(radio) {
    if (!metierLabel || !radio) return;
    let txt = "";

    const card = radio.closest('.avatar-card');
    if (card) {
      const lbl = card.querySelector('.a-label');
      if (lbl) txt = lbl.textContent.trim();
    } else if (radio.dataset && radio.dataset.label) {
      txt = radio.dataset.label;
    } else if (radio.value) {
      txt = radio.value.replace(/^betty_/, "").replace(/_/g, " ");
      txt = txt.charAt(0).toUpperCase() + txt.slice(1);
    }

    if (!txt) txt = "Lawyer";
    metierLabel.innerHTML = 'Selected profession: <strong>' + txt + '</strong>. You can continue configuring your bot.';
  }

  function applySelection(radio){
    const file = radio.getAttribute('data-avatar') || 'avocat.jpg';
    avatarHidden.value = file;

    // Update avatar preview
    const preview = document.getElementById('avatar-preview');
    if (preview) {
      preview.src = AVATAR_BASE + file;
    }

    cards.forEach(c => c.classList.remove('selected'));
    const card = radio.closest('.avatar-card');
    if(card) card.classList.add('selected');

    updateMetierLabelFromRadio(radio);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const checked = document.querySelector('input[name="pack"]:checked');
    if (checked) applySelection(checked);
  });

  packRadios.forEach(r => {
    r.addEventListener('change', () => applySelection(r));
    const card = r.closest('.avatar-card');
    if(card){
      card.addEventListener('click', () => {
        r.checked = true;
        applySelection(r);
      });
    }
  });

  // ====== PROFESSION DRAWER ======
  const drawerToggle   = document.getElementById('drawer-toggle');
  const drawerPanel    = document.getElementById('drawer-panel');
  const drawerRadio    = document.getElementById('drawer-pack-radio');
  const drawerChips    = document.querySelectorAll('.drawer-chip');

  if (drawerToggle && drawerPanel) {
    drawerToggle.addEventListener('click', () => {
      const isHidden = drawerPanel.hasAttribute('hidden');
      if (isHidden) {
        drawerPanel.removeAttribute('hidden');
      } else {
        drawerPanel.setAttribute('hidden', 'hidden');
      }
      drawerToggle.classList.toggle('open');
    });
  }

  drawerChips.forEach(chip => {
    chip.addEventListener('click', () => {
      const pack   = chip.dataset.pack;
      const avatar = chip.dataset.avatar;
      const label  = chip.dataset.label || pack;

      // Hidden radio = profession pack
      drawerRadio.value = pack;
      drawerRadio.setAttribute('data-avatar', avatar);
      drawerRadio.dataset.label = label;
      drawerRadio.checked = true;

      // Visual: deactivate main avatars
      cards.forEach(c => c.classList.remove('selected'));

      // Update avatar + confirmation text
      applySelection(drawerRadio);

      // Visual state on chips
      drawerChips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');

      // Close the drawer for a smoother flow
      drawerPanel.setAttribute('hidden', 'hidden');
      drawerToggle.classList.remove('open');
    });
  });

  // ====== 2D Joystick ======
  const joy  = document.getElementById('joy');
  const thumb= document.getElementById('thumb');
  const ix   = document.getElementById('persona_x');
  const iy   = document.getElementById('persona_y');
  const size = 220, radius = size/2;
  let dragging = false;

  function setThumbFromEvent(ev){
    const rect = joy.getBoundingClientRect();
    let x = (ev.clientX ?? (ev.touches && ev.touches[0].clientX)) - rect.left;
    let y = (ev.clientY ?? (ev.touches && ev.touches[0].clientY)) - rect.top;
    x = Math.max(0, Math.min(size, x));
    y = Math.max(0, Math.min(size, y));
    const nx = (x - radius) / radius;
    const ny = (radius - y) / radius;
    ix.value = nx.toFixed(2);
    iy.value = ny.toFixed(2);
    thumb.style.left = (x - 10) + 'px';
    thumb.style.top  = (y - 10) + 'px';
  }
  function startDrag(ev){ dragging = true; setThumbFromEvent(ev); }
  function moveDrag(ev){ if(dragging){ ev.preventDefault(); setThumbFromEvent(ev); } }
  function endDrag(){ dragging = false; }

  joy.addEventListener('mousedown', startDrag);
  joy.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
  joy.addEventListener('touchstart', startDrag, {passive:false});
  joy.addEventListener('touchmove',  moveDrag,  {passive:false});
  window.addEventListener('touchend', endDrag);

  thumb.style.left = (radius - 10) + 'px';
  thumb.style.top  = (radius - 10) + 'px';
</script>

{% endblock %}
